name: Deploy to Staging

on:
  push:
    branches: [main]

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
            ghcr.io/${{ github.repository }}/backend:staging
          build-args: |
            GIT_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.event.head_commit.timestamp }}

      # --- PLUGGABLE DEPLOY STEP ---
      # Uncomment ONE of the following blocks for your platform:

      # --- Railway ---
      # - name: Deploy to Railway
      #   run: railway up --service ${{ secrets.RAILWAY_SERVICE_ID_STAGING }}
      #   env:
      #     RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      # --- Alibaba Cloud (ACR + ECS) ---
      # - name: Push to Alibaba Cloud ACR
      #   run: |
      #     docker tag ghcr.io/${{ github.repository }}/backend:${{ github.sha }} \
      #       registry.{region}.aliyuncs.com/{namespace}/{service}:${{ github.sha }}
      #     docker push registry.{region}.aliyuncs.com/{namespace}/{service}:${{ github.sha }}
      # - name: Deploy to ECS
      #   run: aliyun ecs ... # Update ECS service with new image

      # --- Google Cloud Run ---
      # - name: Deploy to Cloud Run
      #   uses: google-github-actions/deploy-cloudrun@v2
      #   with:
      #     service: ${{ secrets.GCP_SERVICE_NAME }}
      #     image: ghcr.io/${{ github.repository }}/backend:${{ github.sha }}

      # --- Fly.io ---
      # - name: Deploy to Fly.io
      #   uses: superfly/flyctl-actions/setup-flyctl@main
      # - run: flyctl deploy --image ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
      #   env:
      #     FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      # --- Self-hosted (Docker Compose via SSH) ---
      # - name: Deploy via SSH
      #   run: |
      #     ssh ${{ secrets.DEPLOY_HOST }} "docker pull ghcr.io/${{ github.repository }}/backend:${{ github.sha }} && docker compose up -d"
