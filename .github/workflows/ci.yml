name: CI
# Unified CI workflow replacing test-backend.yml + test-docker-compose.yml

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  backend-lint:
    name: Backend Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Install dependencies
        run: uv sync
        working-directory: backend
      - name: Ruff check
        run: uv run ruff check app/
        working-directory: backend
      - name: Ruff format check
        run: uv run ruff format --check app/
        working-directory: backend
      - name: Mypy
        run: uv run mypy app
        working-directory: backend

  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Install dependencies
        run: uv sync
        working-directory: backend
      - name: Run tests
        run: uv run coverage run -m pytest tests/unit/ tests/integration/ -v
        working-directory: backend
        env:
          SUPABASE_URL: "http://localhost:54321"
          SUPABASE_SERVICE_KEY: "test-service-key"
          CLERK_SECRET_KEY: "test-clerk-key"
          ENVIRONMENT: "local"
      - name: Coverage report
        run: uv run coverage report --fail-under=90
        working-directory: backend
      - name: Coverage HTML
        run: uv run coverage html
        working-directory: backend
      - name: Store coverage files
        uses: actions/upload-artifact@v6
        with:
          name: coverage-html
          path: backend/htmlcov
          include-hidden-files: true

  frontend-ci:
    name: Frontend Lint & Build
    runs-on: ubuntu-latest
    # Only run if frontend/ directory exists
    if: hashFiles('frontend/package.json') != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: frontend
      - name: Lint
        run: bun run lint
        working-directory: frontend
      - name: Build
        run: bun run build
        working-directory: frontend

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-test]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Build backend image
        run: docker build -t test-backend . -f backend/Dockerfile

  # Branch protection gate
  alls-green:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-test, docker-build, frontend-ci]
    if: always()
    steps:
      - name: Check all jobs
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
          allowed-skips: frontend-ci
