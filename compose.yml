services:

  backend:
    image: '${DOCKER_IMAGE_BACKEND:-backend}:${TAG:-latest}'
    restart: always
    networks:
      - traefik-public
      - default
    env_file:
      - .env
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-local}
      - SUPABASE_URL=${SUPABASE_URL:?Variable not set}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY:?Variable not set}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY:?Variable not set}
      - BACKEND_CORS_ORIGINS=${BACKEND_CORS_ORIGINS:-}
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SERVICE_NAME=${SERVICE_NAME:-my-service}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - GIT_COMMIT=${GIT_COMMIT:-unknown}
      - BUILD_TIME=${BUILD_TIME:-unknown}
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/healthz').raise_for_status()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    build:
      context: .
      dockerfile: backend/Dockerfile
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-public
      - traefik.constraint-label=traefik-public
      - traefik.http.services.${STACK_NAME:-app}-backend.loadbalancer.server.port=8000
      - traefik.http.routers.${STACK_NAME:-app}-backend-http.rule=Host(`api.${DOMAIN:-localhost}`)
      - traefik.http.routers.${STACK_NAME:-app}-backend-http.entrypoints=http
      - traefik.http.routers.${STACK_NAME:-app}-backend-https.rule=Host(`api.${DOMAIN:-localhost}`)
      - traefik.http.routers.${STACK_NAME:-app}-backend-https.entrypoints=https
      - traefik.http.routers.${STACK_NAME:-app}-backend-https.tls=true
      - traefik.http.routers.${STACK_NAME:-app}-backend-https.tls.certresolver=le
      - traefik.http.routers.${STACK_NAME:-app}-backend-http.middlewares=https-redirect

  frontend:
    image: '${DOCKER_IMAGE_FRONTEND:-frontend}:${TAG:-latest}'
    profiles: ["ui"]
    restart: always
    networks:
      - traefik-public
      - default
    build:
      context: .
      dockerfile: frontend/Dockerfile
      args:
        - VITE_API_URL=https://api.${DOMAIN:-localhost}
        - NODE_ENV=production
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-public
      - traefik.constraint-label=traefik-public
      - traefik.http.services.${STACK_NAME:-app}-frontend.loadbalancer.server.port=80
      - traefik.http.routers.${STACK_NAME:-app}-frontend-http.rule=Host(`dashboard.${DOMAIN:-localhost}`)
      - traefik.http.routers.${STACK_NAME:-app}-frontend-http.entrypoints=http
      - traefik.http.routers.${STACK_NAME:-app}-frontend-https.rule=Host(`dashboard.${DOMAIN:-localhost}`)
      - traefik.http.routers.${STACK_NAME:-app}-frontend-https.entrypoints=https
      - traefik.http.routers.${STACK_NAME:-app}-frontend-https.tls=true
      - traefik.http.routers.${STACK_NAME:-app}-frontend-https.tls.certresolver=le
      - traefik.http.routers.${STACK_NAME:-app}-frontend-http.middlewares=https-redirect

networks:
  traefik-public:
    external: true
